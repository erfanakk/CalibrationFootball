#pitch.py

from mplsoccer import Pitch
import matplotlib.pyplot as plt
import textwrap
INTERSECTION_TO_PITCH_POINTS = {
    0: "L_GOAL_TL_POST",
    1: "L_GOAL_TR_POST",
    2: "L_GOAL_BL_POST",
    3: "L_GOAL_BR_POST",
    4: "L_GOAL_AREA_BR_CORNER",
    5: "L_GOAL_AREA_TR_CORNER",
    6: "L_GOAL_AREA_BL_CORNER",
    7: "L_GOAL_AREA_TL_CORNER",
    8: "L_PENALTY_AREA_BR_CORNER",
    9: "L_PENALTY_AREA_TR_CORNER",
    10: "L_PENALTY_AREA_BL_CORNER",
    11: "L_PENALTY_AREA_TL_CORNER",
    12: "BL_PITCH_CORNER",
    13: "TL_PITCH_CORNER",
    14: "B_TOUCH_AND_HALFWAY_LINES_INTERSECTION",
    15: "T_TOUCH_AND_HALFWAY_LINES_INTERSECTION",
    16: "R_PENALTY_AREA_BL_CORNER",
    17: "R_PENALTY_AREA_TL_CORNER",
    18: "R_PENALTY_AREA_BR_CORNER",
    19: "R_PENALTY_AREA_TR_CORNER",
    20: "R_GOAL_AREA_BL_CORNER",
    21: "R_GOAL_AREA_TL_CORNER",
    22: "R_GOAL_AREA_BR_CORNER",
    23: "R_GOAL_AREA_TR_CORNER",
    24: "R_GOAL_TL_POST",
    25: "R_GOAL_TR_POST",
    26: "R_GOAL_BL_POST",
    27: "R_GOAL_BR_POST",
    28: "BR_PITCH_CORNER",
    29: "TR_PITCH_CORNER",
    30: "CENTER_CIRCLE_TANGENT_TR",
    31: "CENTER_CIRCLE_TANGENT_TL",
    32: "CENTER_CIRCLE_TANGENT_BR",
    33: "CENTER_CIRCLE_TANGENT_BL",
    34: "CENTER_CIRCLE_TR",
    35: "CENTER_CIRCLE_TL",
    36: "CENTER_CIRCLE_BR",
    37: "CENTER_CIRCLE_BL",
    38: "CENTER_CIRCLE_R",
    39: "CENTER_CIRCLE_L",
    40: "T_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION",
    41: "B_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION",
    42: "CENTER_MARK",
    43: "LEFT_CIRCLE_R",
    44: "BL_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    45: "TL_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    46: "LEFT_CIRCLE_TANGENT_T",
    47: "LEFT_CIRCLE_TANGENT_B",
    48: "L_PENALTY_MARK",
    49: "L_MIDDLE_PENALTY",
    50: "RIGHT_CIRCLE_L",
    51: "BR_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    52: "TR_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    53: "RIGHT_CIRCLE_TANGENT_T",
    54: "RIGHT_CIRCLE_TANGENT_B",
    55: "R_PENALTY_MARK",
    56: "R_MIDDLE_PENALTY",
}
PITCH_POINTS_TO_INTERSECTION = {v: k for k, v in INTERSECTION_TO_PITCH_POINTS.items()}

# https://github.com/NikolasEnt/soccernet-calibration-sportlight/blob/8255f5044bc7f2ef4f77e9c1dc67cf0861045290/src/datatools/ellipse.py#L182
POINTS_LEFT = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 31, 33, 35, 37, 39, 43, 44, 45, 46, 47, 48, 49]
POINTS_RIGHT = [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 32, 34, 36, 38, 50, 51, 52, 53, 54, 55, 56]
NOT_ON_PLANE = [0, 1, 24, 25]

# Used for horizontal flip
LR_SIDES_MAPPING = {
    "L_GOAL_TL_POST": "R_GOAL_TR_POST",
    "L_GOAL_TR_POST": "R_GOAL_TL_POST",
    "L_GOAL_BL_POST": "R_GOAL_BR_POST",
    "L_GOAL_BR_POST": "R_GOAL_BL_POST",
    "L_GOAL_AREA_BR_CORNER": "R_GOAL_AREA_BL_CORNER",
    "L_GOAL_AREA_TR_CORNER": "R_GOAL_AREA_TL_CORNER",
    "L_GOAL_AREA_BL_CORNER": "R_GOAL_AREA_BR_CORNER",
    "L_GOAL_AREA_TL_CORNER": "R_GOAL_AREA_TR_CORNER",
    "L_PENALTY_AREA_BR_CORNER": "R_PENALTY_AREA_BL_CORNER",
    "L_PENALTY_AREA_TR_CORNER": "R_PENALTY_AREA_TL_CORNER",
    "L_PENALTY_AREA_BL_CORNER": "R_PENALTY_AREA_BR_CORNER",
    "L_PENALTY_AREA_TL_CORNER": "R_PENALTY_AREA_TR_CORNER",
    "BL_PITCH_CORNER": "BR_PITCH_CORNER",
    "TL_PITCH_CORNER": "TR_PITCH_CORNER",
    "B_TOUCH_AND_HALFWAY_LINES_INTERSECTION": "B_TOUCH_AND_HALFWAY_LINES_INTERSECTION",  # Same
    "T_TOUCH_AND_HALFWAY_LINES_INTERSECTION": "T_TOUCH_AND_HALFWAY_LINES_INTERSECTION",  # Same
    "R_PENALTY_AREA_BL_CORNER": "L_PENALTY_AREA_BR_CORNER",
    "R_PENALTY_AREA_TL_CORNER": "L_PENALTY_AREA_TR_CORNER",
    "R_PENALTY_AREA_BR_CORNER": "L_PENALTY_AREA_BL_CORNER",
    "R_PENALTY_AREA_TR_CORNER": "L_PENALTY_AREA_TL_CORNER",
    "R_GOAL_AREA_BL_CORNER": "L_GOAL_AREA_BR_CORNER",
    "R_GOAL_AREA_TL_CORNER": "L_GOAL_AREA_TR_CORNER",
    "R_GOAL_AREA_BR_CORNER": "L_GOAL_AREA_BL_CORNER",
    "R_GOAL_AREA_TR_CORNER": "L_GOAL_AREA_TL_CORNER",
    "R_GOAL_TL_POST": "L_GOAL_TR_POST",
    "R_GOAL_TR_POST": "L_GOAL_TL_POST",
    "R_GOAL_BL_POST": "L_GOAL_BR_POST",
    "R_GOAL_BR_POST": "L_GOAL_BL_POST",
    "BR_PITCH_CORNER": "BL_PITCH_CORNER",
    "TR_PITCH_CORNER": "TL_PITCH_CORNER",
    "CENTER_CIRCLE_TANGENT_TR": "CENTER_CIRCLE_TANGENT_TL",
    "CENTER_CIRCLE_TANGENT_TL": "CENTER_CIRCLE_TANGENT_TR",
    "CENTER_CIRCLE_TANGENT_BR": "CENTER_CIRCLE_TANGENT_BL",
    "CENTER_CIRCLE_TANGENT_BL": "CENTER_CIRCLE_TANGENT_BR",
    "CENTER_CIRCLE_TR": "CENTER_CIRCLE_TL",
    "CENTER_CIRCLE_TL": "CENTER_CIRCLE_TR",
    "CENTER_CIRCLE_BR": "CENTER_CIRCLE_BL",
    "CENTER_CIRCLE_BL": "CENTER_CIRCLE_BR",
    "CENTER_CIRCLE_R": "CENTER_CIRCLE_L",
    "CENTER_CIRCLE_L": "CENTER_CIRCLE_R",
    "T_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION": "T_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION",  # Same
    "B_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION": "B_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION",  # Same
    "CENTER_MARK": "CENTER_MARK",  # Same
    "LEFT_CIRCLE_R": "RIGHT_CIRCLE_L",
    "BL_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "BR_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "TL_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "TR_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "LEFT_CIRCLE_TANGENT_T": "RIGHT_CIRCLE_TANGENT_T",
    "LEFT_CIRCLE_TANGENT_B": "RIGHT_CIRCLE_TANGENT_B",
    "L_PENALTY_MARK": "R_PENALTY_MARK",
    "L_MIDDLE_PENALTY": "R_MIDDLE_PENALTY",
    "RIGHT_CIRCLE_L": "LEFT_CIRCLE_R",
    "BR_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "BL_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "TR_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "TL_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "RIGHT_CIRCLE_TANGENT_T": "LEFT_CIRCLE_TANGENT_T",
    "RIGHT_CIRCLE_TANGENT_B": "LEFT_CIRCLE_TANGENT_B",
    "R_PENALTY_MARK": "L_PENALTY_MARK",
    "R_MIDDLE_PENALTY": "L_MIDDLE_PENALTY",
}

TOP_BOTTOM_MAPPING = {
    "CENTER_MARK": "CENTER_MARK",
    "TL_PITCH_CORNER": "BL_PITCH_CORNER",
    "BL_PITCH_CORNER": "TL_PITCH_CORNER",
    "TR_PITCH_CORNER": "BR_PITCH_CORNER",
    "BR_PITCH_CORNER": "TR_PITCH_CORNER",
    "L_PENALTY_MARK": "L_PENALTY_MARK",
    "R_PENALTY_MARK": "R_PENALTY_MARK",
    "L_PENALTY_AREA_TL_CORNER": "L_PENALTY_AREA_BL_CORNER",
    "L_PENALTY_AREA_TR_CORNER": "L_PENALTY_AREA_BR_CORNER",
    "L_PENALTY_AREA_BL_CORNER": "L_PENALTY_AREA_TL_CORNER",
    "L_PENALTY_AREA_BR_CORNER": "L_PENALTY_AREA_TR_CORNER",
    "R_PENALTY_AREA_TL_CORNER": "R_PENALTY_AREA_BL_CORNER",
    "R_PENALTY_AREA_TR_CORNER": "R_PENALTY_AREA_BR_CORNER",
    "R_PENALTY_AREA_BL_CORNER": "R_PENALTY_AREA_TL_CORNER",
    "R_PENALTY_AREA_BR_CORNER": "R_PENALTY_AREA_TR_CORNER",
    "L_GOAL_AREA_TL_CORNER": "L_GOAL_AREA_BL_CORNER",
    "L_GOAL_AREA_TR_CORNER": "L_GOAL_AREA_BR_CORNER",
    "L_GOAL_AREA_BL_CORNER": "L_GOAL_AREA_TL_CORNER",
    "L_GOAL_AREA_BR_CORNER": "L_GOAL_AREA_TR_CORNER",
    "R_GOAL_AREA_TL_CORNER": "R_GOAL_AREA_BL_CORNER",
    "R_GOAL_AREA_TR_CORNER": "R_GOAL_AREA_BR_CORNER",
    "R_GOAL_AREA_BL_CORNER": "R_GOAL_AREA_TL_CORNER",
    "R_GOAL_AREA_BR_CORNER": "R_GOAL_AREA_TR_CORNER",
    "L_GOAL_TL_POST": "L_GOAL_TR_POST",
    "L_GOAL_TR_POST": "L_GOAL_TL_POST",
    "L_GOAL_BL_POST": "L_GOAL_BR_POST",
    "L_GOAL_BR_POST": "L_GOAL_BL_POST",
    "R_GOAL_TL_POST": "R_GOAL_TR_POST",
    "R_GOAL_TR_POST": "R_GOAL_TL_POST",
    "R_GOAL_BL_POST": "R_GOAL_BR_POST",
    "R_GOAL_BR_POST": "R_GOAL_BL_POST",
    "T_TOUCH_AND_HALFWAY_LINES_INTERSECTION": "B_TOUCH_AND_HALFWAY_LINES_INTERSECTION",
    "B_TOUCH_AND_HALFWAY_LINES_INTERSECTION": "T_TOUCH_AND_HALFWAY_LINES_INTERSECTION",
    "T_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION": "B_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION",
    "B_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION": "T_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION",
    "TL_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "BL_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "BL_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "TL_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "TR_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "BR_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "BR_16M_LINE_AND_PENALTY_ARC_INTERSECTION": "TR_16M_LINE_AND_PENALTY_ARC_INTERSECTION",
    "CENTER_CIRCLE_TANGENT_TR": "CENTER_CIRCLE_TANGENT_BR",
    "CENTER_CIRCLE_TANGENT_TL": "CENTER_CIRCLE_TANGENT_BL",
    "CENTER_CIRCLE_TANGENT_BR": "CENTER_CIRCLE_TANGENT_TR",
    "CENTER_CIRCLE_TANGENT_BL": "CENTER_CIRCLE_TANGENT_TL",
    "CENTER_CIRCLE_TR": "CENTER_CIRCLE_BR",
    "CENTER_CIRCLE_TL": "CENTER_CIRCLE_BL",
    "CENTER_CIRCLE_BR": "CENTER_CIRCLE_TR",
    "CENTER_CIRCLE_BL": "CENTER_CIRCLE_TL",
    "CENTER_CIRCLE_R": "CENTER_CIRCLE_R",
    "CENTER_CIRCLE_L": "CENTER_CIRCLE_L",
    "LEFT_CIRCLE_R": "LEFT_CIRCLE_R",
    "RIGHT_CIRCLE_L": "RIGHT_CIRCLE_L",
    "LEFT_CIRCLE_TANGENT_T": "LEFT_CIRCLE_TANGENT_B",
    "LEFT_CIRCLE_TANGENT_B": "LEFT_CIRCLE_TANGENT_T",
    "L_MIDDLE_PENALTY": "L_MIDDLE_PENALTY",
    "RIGHT_CIRCLE_TANGENT_T": "RIGHT_CIRCLE_TANGENT_B",
    "RIGHT_CIRCLE_TANGENT_B": "RIGHT_CIRCLE_TANGENT_T",
    "R_MIDDLE_PENALTY": "R_MIDDLE_PENALTY",
}
# Lines, which are perpendicular to the main axis of the pitch
PERP_LINES = [
    (0, 1),
    (2, 3),
    (4, 5),
    (6, 7),
    (8, 9),
    (10, 11),
    (12, 13),
    (14, 15),
    (16, 17),
    (18, 19),
    (20, 21),
    (22, 23),
    (24, 25),
    (26, 27),
    (28, 29),
    (41, 40),
    (44, 45),
    (51, 52),
]

GROUND_TRUTH_POINTS = {
    "CENTER_MARK": (52.5, 34.0, 0.0),
    "TL_PITCH_CORNER": (0.0, 68.0, 0.0),
    "BL_PITCH_CORNER": (0.0, 0.0, 0.0),
    "TR_PITCH_CORNER": (105.0, 68.0, 0.0),
    "BR_PITCH_CORNER": (105.0, 0.0, 0.0),
    "L_PENALTY_MARK": (11.0, 34.0, 0.0),
    "R_PENALTY_MARK": (94.0, 34.0, 0.0),
    "L_PENALTY_AREA_TL_CORNER": (0.0, 54.16, 0.0),
    "L_PENALTY_AREA_TR_CORNER": (16.5, 54.16, 0.0),
    "L_PENALTY_AREA_BL_CORNER": (0.0, 13.84, 0.0),
    "L_PENALTY_AREA_BR_CORNER": (16.5, 13.84, 0.0),
    "R_PENALTY_AREA_TL_CORNER": (88.5, 54.16, 0.0),
    "R_PENALTY_AREA_TR_CORNER": (105.0, 54.16, 0.0),
    "R_PENALTY_AREA_BL_CORNER": (88.5, 13.84, 0.0),
    "R_PENALTY_AREA_BR_CORNER": (105.0, 13.84, 0.0),
    "L_GOAL_AREA_TL_CORNER": (0.0, 43.16, 0.0),
    "L_GOAL_AREA_TR_CORNER": (5.5, 43.16, 0.0),
    "L_GOAL_AREA_BL_CORNER": (0.0, 24.84, 0.0),
    "L_GOAL_AREA_BR_CORNER": (5.5, 24.84, 0.0),
    "R_GOAL_AREA_TL_CORNER": (99.5, 43.16, 0.0),
    "R_GOAL_AREA_TR_CORNER": (105.0, 43.16, 0.0),
    "R_GOAL_AREA_BL_CORNER": (99.5, 24.84, 0.0),
    "R_GOAL_AREA_BR_CORNER": (105.0, 24.84, 0.0),
    "L_GOAL_TL_POST": (0.0, 30.34, -2.44),
    "L_GOAL_TR_POST": (0.0, 37.66, -2.44),
    "L_GOAL_BL_POST": (0.0, 30.34, 0.0),
    "L_GOAL_BR_POST": (0.0, 37.66, 0.0),
    "R_GOAL_TL_POST": (105.0, 37.66, -2.44),
    "R_GOAL_TR_POST": (105.0, 30.34, -2.44),
    "R_GOAL_BL_POST": (105.0, 37.66, 0.0),
    "R_GOAL_BR_POST": (105.0, 30.34, 0.0),
    "T_TOUCH_AND_HALFWAY_LINES_INTERSECTION": (52.5, 68.0, 0.0),
    "B_TOUCH_AND_HALFWAY_LINES_INTERSECTION": (52.5, 0.0, 0.0),
    "T_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION": (52.5, 43.15, 0.0),
    "B_HALFWAY_LINE_AND_CENTER_CIRCLE_INTERSECTION": (52.5, 24.85, 0.0),
    "TL_16M_LINE_AND_PENALTY_ARC_INTERSECTION": (16.5, 41.31248931623151, 0.0),
    "BL_16M_LINE_AND_PENALTY_ARC_INTERSECTION": (16.5, 26.687510683768487, 0.0),
    "TR_16M_LINE_AND_PENALTY_ARC_INTERSECTION": (88.5, 41.31248931623151, 0.0),
    "BR_16M_LINE_AND_PENALTY_ARC_INTERSECTION": (88.5, 26.687510683768487, 0.0),
    "CENTER_CIRCLE_TANGENT_TR": (61.31243189346428, 36.462426470588234, 0.0),
    "CENTER_CIRCLE_TANGENT_TL": (43.68756810653572, 36.46242647058824, 0.0),
    "CENTER_CIRCLE_TANGENT_BR": (61.31243189346428, 31.537573529411766, 0.0),
    "CENTER_CIRCLE_TANGENT_BL": (43.68756810653572, 31.53757352941176, 0.0),
    "CENTER_CIRCLE_TR": (58.97002704785691, 40.47002704785691, 0.0),
    "CENTER_CIRCLE_TL": (46.02997295214309, 40.47002704785691, 0.0),
    "CENTER_CIRCLE_BR": (58.97002704785691, 27.52997295214309, 0.0),
    "CENTER_CIRCLE_BL": (46.02997295214309, 27.52997295214309, 0.0),
    "CENTER_CIRCLE_R": (61.65, 34.0, 0.0),
    "CENTER_CIRCLE_L": (43.35, 34.0, 0.0),
    "LEFT_CIRCLE_R": (20.15, 34.0, 0.0),
    "RIGHT_CIRCLE_L": (84.85, 34.0, 0.0),
    "LEFT_CIRCLE_TANGENT_T": (19.9906727467215, 35.70008928040832, 0.0),
    "LEFT_CIRCLE_TANGENT_B": (19.9906727467215, 32.29991071959168, 0.0),
    "L_MIDDLE_PENALTY": (16.5, 34.0, 0.0),
    "RIGHT_CIRCLE_TANGENT_T": (85.0093272532785, 35.70008928040832, 0.0),
    "RIGHT_CIRCLE_TANGENT_B": (85.0093272532785, 32.29991071959168, 0.0),
    "R_MIDDLE_PENALTY": (88.5, 34.0, 0.0),
}


GROUND_TRUTH_POINTS_NORMALIZED = {}
WIDTH = 105  # X
HEIGHT = 68  # Y
TARGET_WIDTH = 100
TARGET_HEIGHT = 100
for key, (x, y, z) in GROUND_TRUTH_POINTS.items():
    GROUND_TRUTH_POINTS_NORMALIZED[key] = (
        x / WIDTH * TARGET_WIDTH,
        y / HEIGHT * TARGET_HEIGHT,
        z,
    )

n_points = len(GROUND_TRUTH_POINTS)
cmap = plt.cm.get_cmap('hsv', n_points)  # or 'tab20', 'viridis', etc.
colors = [cmap(i) for i in range(n_points)]
abbr = {pt: "_".join([seg[:3] for seg in pt.split("_")]) 
        for pt in GROUND_TRUTH_POINTS}



if __name__ == "__main__":



    # Exact points per uefa rules
    pitch = Pitch(pitch_type="uefa", linewidth=0.8, pitch_color="black")
    fig, ax = pitch.draw()
    fig.set_facecolor("black")
    for point in GROUND_TRUTH_POINTS:
        x, y, z = GROUND_TRUTH_POINTS[point]
        ax.scatter(x, y, color="white")
        ax.text(
                    x, 
                    y + 1.2, 
                    abbr[point], 
                    color="white", 
                    ha="center", 
                    va="bottom", 
                    fontsize=6
                )

    # Normalized points for 100x100 opta coordinates (a little bit off)
    pitch = Pitch(pitch_type="opta")
    fig, ax = pitch.draw()
    for point in GROUND_TRUTH_POINTS_NORMALIZED:
        x, y, z = GROUND_TRUTH_POINTS_NORMALIZED[point]
        ax.plot(x, y, "ro")
    plt.savefig("pitch.png", dpi=300)
    plt.show()


    pitch = Pitch(pitch_type="uefa", linewidth=0.8, pitch_color="black")
    # Create a big figure: 12×8 inches at 300 DPI → 3600×2400 pixels
    fig, ax = pitch.draw(figsize=(16, 12))
    fig.set_facecolor("black")

    for idx, (point, (x, y, z)) in enumerate(GROUND_TRUTH_POINTS.items()):
        c = colors[idx]
        ax.scatter(x, y,s=10,color=c)  # maybe bump marker size
        ax.text(
            x, 
            y + 0.6, 
            abbr[point], 
            ha="center", 
            va="bottom", 
            fontsize=6,  # tweak as needed
            color=c
        )

    fig.savefig("pitch_large.png",bbox_inches="tight",dpi=300)
    plt.show()

